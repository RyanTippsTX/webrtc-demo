<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Video + Chat POC</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; }
    textarea { width: 100%; height: 80px; }
    #chat { border: 1px solid #ccc; padding: 1em; height: 150px; overflow-y: auto; margin-bottom: 1em; }
    #videos { display: flex; gap: 1em; margin-bottom: 1em; }
    video { width: 45%; background: #000; }
  </style>
</head>
<body>
  <h1>Peer-to-Peer Video + Chat</h1>

  <!-- Video elements -->
  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <button id="startCam">Start Webcam</button>

  <hr>

  <!-- Manual SDP exchange -->
  <h2>1) Offer / Answer</h2>
  <button id="makeOffer">Make Offer</button>
  <button id="makeAnswer">Make Answer</button>
  <div>
    <p><strong>Local SDP:</strong></p>
    <textarea id="localSDP" readonly></textarea>
    <p><strong>Remote SDP:</strong></p>
    <textarea id="remoteSDP"></textarea>
    <button id="setRemote">Set Remote SDP</button>
  </div>

  <hr>

  <!-- Chat UI -->
  <h2>2) Chat</h2>
  <div id="chat"></div>
  <input type="text" id="messageInput" placeholder="Type a message…" />
  <button id="sendBtn">Send</button>

  <script>
    const pc = new RTCPeerConnection({ iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      // TURN server example
      // {
      //   urls: [
      //     "turn:turn.myprovider.com:3478",         // UDP/TCP
      //     "turns:turn.myprovider.com:443?transport=tcp"  // TLS over TCP
      //   ],
      //   username: "yourTurnUser",     // supplied by provider
      //   credential: "yourTurnSecret"  // ditto
      // }
    ]});
    let dc;
    let localStream;

    // 1) Start webcam and add tracks
    document.getElementById('startCam').onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('localVideo').srcObject = localStream;
      // Add all tracks to the PeerConnection
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      appendMessage("[system] Webcam started");
    };

    // 2) When remote track arrives, show it
    pc.ontrack = e => {
      // for simplicity, assume single remote stream
      document.getElementById('remoteVideo').srcObject ||= new MediaStream();
      document.getElementById('remoteVideo').srcObject.addTrack(e.track);
    };

    // ICE gathering → output SDP when complete
    pc.onicecandidate = e => {
      if (!e.candidate) {
        document.getElementById('localSDP').value = JSON.stringify(pc.localDescription);
      }
    };

    // Offer
    document.getElementById('makeOffer').onclick = async () => {
      // also create DataChannel
      dc = pc.createDataChannel("chat");
      setupDataChannel();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    };

    // Answer
    document.getElementById('makeAnswer').onclick = async () => {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
    };

    // Set remote SDP
    document.getElementById('setRemote').onclick = async () => {
      const remoteDesc = JSON.parse(document.getElementById('remoteSDP').value);
      await pc.setRemoteDescription(new RTCSessionDescription(remoteDesc));
    };

    // DataChannel handlers
    function setupDataChannel() {
      dc.onopen = () => appendMessage("[system] DataChannel open");
      dc.onmessage = e => appendMessage("Peer: " + e.data);
    }

    // Send chat messages
    document.getElementById('sendBtn').onclick = () => {
      const txt = document.getElementById('messageInput').value;
      if (!dc || dc.readyState !== "open") return alert("DataChannel not open yet");
      dc.send(txt);
      appendMessage("You: " + txt);
      document.getElementById('messageInput').value = "";
    };

    function appendMessage(msg) {
      const p = document.createElement('p');
      p.textContent = msg;
      document.getElementById('chat').appendChild(p);
      document.getElementById('chat').scrollTop = 1e9;
    }
  </script>
</body>
</html>
